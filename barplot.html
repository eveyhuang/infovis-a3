<!DOCTYPE html>
<meta charset="utf-8">
          
<!-- Load d3.js -->
<script src="https://d3js.org/d3.v6.js"></script>

<!-- Initialize a select button for the Level -->
<select id="selectLevel"></select>

<!-- Initialize a select button for the demographic -->
<select id="selectDemoType"></select>
          
<!-- Create a div container to hold SVG -->
<div id="sortedBarplot"></div>

<link href="style.css" rel="stylesheet">

<script>

    // set the dimensions and margins of the graph
    const margin = {top: 40, right: 30, bottom: 70, left: 60},
        width = 600 - margin.left - margin.right,
        height = 450 - margin.top - margin.bottom;
    
    // append the svg object to the body of the page
    const svg = d3.select("#sortedBarplot")
      .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
      .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);


    // Parse the Data
    d3.csv("data/all_levels_tidy_SA.csv").then( function(data) {

        // Set data type
        data.forEach(function(d) {
            d.DemoValue = parseFloat(d.DemoValue);
        });
        // console.log(data);

        // ****************************************************************************************
        // DROP-DOWN MENU SETUP
        // ****************************************************************************************

        // Get set of schooling levels - PRIMARY, LS, US
        const schoolLevels = new Set(data.map(d => d.Level))
        // Set default school level
        const selectedLevel = "Primary"
        // Set colors for each school level
        // const levelColour = d3.scaleOrdinal()
        // .domain(schoolLevels)
        // .range(d3.schemeSet2);

        // Add school levels as options to dropdown menu
        d3.select("#selectLevel")
        .selectAll('schoolLevels')
            .data(schoolLevels)
        .enter()
            .append('option')
        .text(function (d) { return d + " School"; }) // Drop-Down Menu text
        .attr("value", function (d) { return d; }) // Value returned by drop-down menu

        // Get set of demoTypes to plot for
        const demoTypes = ['Total', 'Gender', 'Residence']
        // Set default demographic
        const selectedDemoType = 'Total'

       // Add demographics as options to dropdown menu
       d3.select("#selectDemoType")
        .selectAll('demoTypes')
            .data(demoTypes)
        .enter()
            .append('option')
        .text(function (d) { return d.replace(/([a-z])([A-Z])/g, '$1 $2'); }) // Drop-Down Menu text (split camel-case for pretty display)
        .attr("value", function (d) { return d; }) // Value returned by drop-down menu
        
        // ****************************************************************************************
        // DATA-FILTRATION, TITLE, AND AXES SETUP
        // ****************************************************************************************

        // Filter data by the defaut level, and also by the default demoType,
        // and also sort it by the value of the default demographic
        const filteredData = data.filter(d => d.Level === selectedLevel)
        .filter(d => d.DemoType === selectedDemoType)
        .sort((a, b) => b['DemoValue'] - a['DemoValue'])
        // console.log(filteredData)

        // // Choose colours
        // const colorScale = d3.scaleOrdinal()
        // .domain(d => d.DemoCategory)
        // .range(['#e41a1c','#377eb8'])

        // Add a title woohoo!
        svg.append("text")
        .attr("x", (width / 2))             
        .attr("y", 0 - (margin.top / 1.8))
        .attr("text-anchor", "middle")  
        .style("font-size", "18px") 
        .style("text-decoration", "underline")  
        .text("South-East Asian Countries, Ranked by Percentage of Dropouts");

        // X Scale setup
        const xScale = d3.scaleBand() // allows scaling of bars
        .domain(filteredData.map(d => d.Country)) // map the country names to the x axis
        .range([ 0, width ]) //set range
        .paddingInner(0.2); // set the padding between the bars
        
        // XZ Scale setup i.e. for side-by-side bars
        const xzScale = d3.scaleBand()
        .domain(filteredData.map(d => d.DemoCategory)) 
        .range([0, xScale.bandwidth()]) // set range
        .padding(0.05); // set the padding within the bars
        // console.log(xzScale.domain())

        // Z Scale setup
        const zScale = d3.scaleOrdinal()
        .domain(filteredData.map(d => d.DemoCategory)) // 
        .range(d3.schemeSet2); // set the range of colours

        // Y Scale setup
        const yScale = d3.scaleLinear()
        .domain([0, d3.max(filteredData, function(d) { return d.DemoValue; })+10])
        //.domain([0, d3.max()]) // **SEE HERE**: Set it according to the demo + level
        .range([ height, 0]);


        // Make X-axis + customise the positioning of xticks
        var xAxis = d3.axisBottom(xScale);

        svg.append("g")
        .attr("class", "xAxis")
        .attr("transform", `translate(0, ${height})`)
        .call(xAxis)
        .selectAll("text")
            .attr("transform", "translate(5,5)rotate(-30)") // rotation for readability
            .style("text-anchor", "end") // for vertical alignment
            .attr("font-size","11px"); // font size

        // Add X-label
        svg.append("text")
        .attr("class", "xlabel")
        .attr("text-anchor", "end")
        .attr("x", (width + margin.left + margin.right)/2) // Position x-label
        .attr("y", height + margin.bottom)
        .text("Countries"); // Label

        // Make Y-axis + customise the positioning of yticks and the grid
        var yAxis = d3.axisLeft(yScale)
        .tickFormat(d => d + " %");
        var yAxisGrid = d3.axisLeft(yScale).tickSize(-width).tickFormat('').ticks(10);

        svg.append("g") 
        .attr("class", "yAxis")
        .call(yAxis)
        // .call(g => g.selectAll(".tick line").clone() // make y gridlines
        //   .attr("x2", width )
        //   .attr("stroke-opacity", 0.1))
        .selectAll("text")
            .attr("font-size","11px"); // font size

        // Add y-label
        svg.append("text")
        .attr("class", "ylabel")
        .attr("text-anchor", "end")
        .attr("y", -margin.left/1.3) // **SEE HERE**: mind these if you change the margins or width/height
        .attr("x", margin.bottom - height/1.8) // **SEE HERE**: mind these if you change the margins or width/height
        .attr("transform", "rotate(-90)")
        .text("Out of School Rate"); // Label

        // Add the Y gridlines
        svg.append('g')
            .attr('class', 'yaxis-grid')
            .call(yAxisGrid);


        // ****************************************************************************************
        // MAKING THE BARS
        // ****************************************************************************************

        // Make the bars with the default school level + demographic to start with
        const barplot = svg.selectAll("rect")
        .data(filteredData) 
        .join("rect")
        .attr("x", d => xScale(d.Country))
        .attr("y", d => yScale(d.DemoValue))
        .attr("width", xzScale.bandwidth())
        .attr("height", d => height - yScale(d.DemoValue))
        .attr("fill", d => zScale(d.DemoCategory))
        // Animation: show no bars at the start
        .attr("height", function(d) { return height - yScale(0); }) // always equal to 0
        .attr("y", function(d) { return yScale(0); });


        // Animation
        svg.selectAll("rect")
        .transition()
        .duration(400)
        .attr("y", function(d) { return yScale(d.DemoValue); })
        .attr("height", function(d) { return height - yScale(d.DemoValue); })
        //.delay(function(d,i){console.log(i) ; return(i*100)})

        // ****************************************************************************************
        // UPDATE FUNCTION DECLARATIONS
        // ****************************************************************************************

        // Function to update visualization based on school level selected
        function updateLevel(selectedLevel) {

            // Filter data by the defaut level, and also by the default demoType,
            // and also sort it by the value of the default demographic
            const filteredData = data.filter(d => d.Level === selectedLevel)
            .filter(d => d.DemoType === selectedDemoType)
            .sort((a, b) => b['DemoValue'] - a['DemoValue']);

            // Update the yScale
            yScale.domain([0, d3.max(filteredData, function(d) { return d.DemoValue; })+10]);
            // Update the yAxis and yAxisGrid
            var yAxis = d3.axisLeft(yScale)
            .tickFormat(d => d + " %");
            var yAxisGrid = d3.axisLeft(yScale).tickSize(-width)
            .tickFormat('').ticks(10);
            // Re-draw the yAxis and yAxisGrid
            svg.selectAll("g .yAxis")
            .call(yAxis)
            svg.selectAll("g .yaxis-grid")
            .call(yAxisGrid);

            // Update the xScale
            xScale.domain(filteredData.map(d => d.Country));
            // Update the xAxis
            var xAxis = d3.axisBottom(xScale)
            // Re-draw the xAxis
            svg.selectAll("g .xAxis")
            .call(xAxis)

            // Update the barplot based on the selected school level
            barplot.data(filteredData)
            .join("rect")
            .attr("x", d => xScale(d.Country))
            .attr("y", d => yScale(d.DemoValue))
            .attr("width", xzScale.bandwidth())
            .attr("height", d => height - yScale(d.DemoValue))
            .attr("fill", d => zScale(d.DemoCategory))
            // Animation: show no bars at the start
            .attr("height", function(d) { return height - yScale(0); }) // always equal to 0
            .attr("y", function(d) { return yScale(0); });

            // Animation
            svg.selectAll("rect")
            .transition()
            .duration(400)
            .attr("y", function(d) { return yScale(d.DemoValue); })
            .attr("height", function(d) { return height - yScale(d.DemoValue); });

        }

        // Function to update visualization based on demo type (total, gender, residence) selected
        function updateDemoType(selectedDemoType) {

            // Filter data by the defaut level, and also by the default demoType,
            // and also sort it by the value of the default demographic
            const filteredData = data.filter(d => d.Level === selectedLevel)
            .filter(d => d.DemoType === selectedDemoType)
            .sort((a, b) => b['DemoValue'] - a['DemoValue'])

        }

        // ****************************************************************************************
        // UPDATE FUNCTION CALLS
        // ****************************************************************************************

        // Call to update visualization when button changes
        d3.select("#selectLevel").on("change", function(event,d) {
            // recover the option that has been chosen
            const selectedLevel = d3.select(this).property("value")
            // run the update function with this selected option
            updateLevel(selectedLevel)
        })

        // Call to update visualization when button changes
        d3.select("#selectDemoType").on("change", function(event,d) {
            // recover the option that has been chosen
            const selectedDemoType = d3.select(this).property("value")
            // run the update function with this selected option
            updateDemoType(selectedDemoType)
        })


    })

</script>
</html> 